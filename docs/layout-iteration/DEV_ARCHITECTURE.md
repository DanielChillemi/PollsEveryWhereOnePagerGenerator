<!--
æ–‡ä»¶ï¼šdocs/layout-iteration/DEV_ARCHITECTURE.md
ç”¨é€”ï¼šLayout IterationåŠŸèƒ½çš„æ¶æ„è®¾è®¡è¯´æ˜
åˆ›å»ºæ—¥æœŸï¼š2025-01-18
æœ€åæ›´æ–°ï¼š2025-01-18
-->

# Layout Iteration åŠŸèƒ½æ¶æ„è®¾è®¡

## ğŸ“‹ ç›®å½•
1. [ç³»ç»Ÿæ¦‚è§ˆ](#ç³»ç»Ÿæ¦‚è§ˆ)
2. [æ•°æ®æ¶æ„](#æ•°æ®æ¶æ„)
3. [åç«¯æ¶æ„](#åç«¯æ¶æ„)
4. [å‰ç«¯æ¶æ„](#å‰ç«¯æ¶æ„)
5. [æ•°æ®æµ](#æ•°æ®æµ)
6. [å…³é”®æŠ€æœ¯å†³ç­–](#å…³é”®æŠ€æœ¯å†³ç­–)

---

## ç³»ç»Ÿæ¦‚è§ˆ

### æ ¸å¿ƒé—®é¢˜
å½“å‰ç³»ç»Ÿåªèƒ½è¿­ä»£å†…å®¹ï¼ˆæ–‡å­—ï¼‰ï¼Œæ— æ³•è¿­ä»£è®¾è®¡ï¼ˆå¸ƒå±€ã€æ ·å¼ï¼‰ï¼Œä¸ç¬¦åˆé¡¹ç›®éœ€æ±‚ã€‚

### è§£å†³æ–¹æ¡ˆ
æ‰©å±•ç³»ç»Ÿï¼Œè®©AIåœ¨è¿­ä»£æ—¶åŒæ—¶ä¼˜åŒ–å†…å®¹å’Œè®¾è®¡å‚æ•°ï¼Œå¹¶æä¾›Wireframeä½ä¿çœŸé¢„è§ˆã€‚

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·ç•Œé¢å±‚                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Wireframe    â”‚   â”‚ Preview      â”‚   â”‚ Design       â”‚  â”‚
â”‚  â”‚ Preview      â”‚   â”‚ Mode         â”‚   â”‚ Control      â”‚  â”‚
â”‚  â”‚              â”‚   â”‚              â”‚   â”‚ Panel        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â†“                  â†“                  â†“           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      React Queryå±‚                          â”‚
â”‚  (useOnePager, useUpdateLayout, useSuggestLayout)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APIå±‚                                â”‚
â”‚  POST /onepagers/{id}/refine                               â”‚
â”‚  POST /onepagers/{id}/suggest-layout                       â”‚
â”‚  POST /onepagers/{id}/export-pdf                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸šåŠ¡é€»è¾‘å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ AI Service   â”‚   â”‚ PDF Service  â”‚   â”‚ OnePager     â”‚  â”‚
â”‚  â”‚              â”‚   â”‚              â”‚   â”‚ Service      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                   â†“                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  MongoDB - onepagers collection                      â”‚ â”‚
â”‚  â”‚  {                                                    â”‚ â”‚
â”‚  â”‚    content: {...},                                    â”‚ â”‚
â”‚  â”‚    layout_params: {...},  â† æ–°å¢                     â”‚ â”‚
â”‚  â”‚    design_rationale: "..."  â† æ–°å¢                   â”‚ â”‚
â”‚  â”‚  }                                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å¤–éƒ¨æœåŠ¡                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ OpenAI       â”‚   â”‚ Playwright   â”‚                      â”‚
â”‚  â”‚ GPT-4        â”‚   â”‚ (PDFç”Ÿæˆ)    â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®æ¶æ„

### æ ¸å¿ƒæ•°æ®æ¨¡å‹

#### LayoutParamsï¼ˆæ–°å¢ï¼‰
```python
{
  "color_scheme": {
    "primary": "#1568B8",
    "secondary": "#864CBD",
    "accent": "#FF6B6B",
    "text_primary": "#1A202C",
    "background": "#FFFFFF"
  },
  "typography": {
    "heading_font": "Inter",
    "body_font": "Inter",
    "h1_scale": 1.0,        # 0.8-1.5
    "h2_scale": 1.0,        # 0.8-1.5
    "body_scale": 1.0,      # 0.8-1.3
    "line_height_scale": 1.0  # 0.8-1.4
  },
  "spacing": {
    "section_gap": "normal",  # tight|normal|loose
    "padding_scale": 1.0      # 0.5-2.0
  },
  "section_layouts": {
    "features": {
      "columns": 2,           # 1|2|3
      "alignment": "left"     # left|center|right
    },
    "benefits": {
      "columns": 1,
      "alignment": "center"
    }
  }
}
```

#### OnePagerï¼ˆæ‰©å±•ï¼‰
```python
{
  "_id": ObjectId("..."),
  "user_id": "...",
  "title": "...",
  "content": {
    "headline": "...",
    "subheadline": "...",
    "problem": "...",
    "solution": "...",
    "features": [...],
    "benefits": [...],
    "social_proof": "...",
    "cta": {"text": "...", "url": "..."}
  },
  "brand_kit_id": "...",
  "template": "minimalist",

  # âœ¨ æ–°å¢å­—æ®µ
  "layout_params": {...},     # LayoutParamså¯¹è±¡ï¼Œå¯é€‰
  "design_rationale": "...",  # AIçš„è®¾è®¡ç†ç”±ï¼Œå¯é€‰

  "version": 3,
  "version_history": [
    {
      "version": 2,
      "content": {...},
      "layout_params": {...},  # âœ¨ ç‰ˆæœ¬å†å²ä¹Ÿä¿å­˜layout
      "timestamp": "...",
      "feedback": "..."
    }
  ],
  "created_at": "...",
  "updated_at": "..."
}
```

### æ•°æ®åº“å˜æ›´

#### è¿ç§»ç­–ç•¥
1. **æ–°å­—æ®µä¸ºå¯é€‰**ï¼šlayout_paramså’Œdesign_rationaleéƒ½æ˜¯Optional
2. **é»˜è®¤å€¼æ³¨å…¥**ï¼šè¿ç§»è„šæœ¬ä¸ºç°æœ‰æ•°æ®æ·»åŠ é»˜è®¤layout_params
3. **ç‰ˆæœ¬å†å²æ‰©å±•**ï¼šæ–°çš„ç‰ˆæœ¬å¿«ç…§åŒ…å«layout_params
4. **å‘åå…¼å®¹**ï¼šå¦‚æœlayout_paramsä¸ºNoneï¼Œä½¿ç”¨é»˜è®¤å€¼

#### ç´¢å¼•ç­–ç•¥
æ— éœ€æ–°å¢ç´¢å¼•ï¼Œç°æœ‰çš„user_idç´¢å¼•è¶³å¤Ÿã€‚

---

## åç«¯æ¶æ„

### ç›®å½•ç»“æ„ï¼ˆæ–°å¢æ–‡ä»¶ï¼‰

```
backend/
â”œâ”€â”€ models/
â”‚   â””â”€â”€ onepager.py             # âœ¨ æ·»åŠ LayoutParamsç±»
â”‚
â”œâ”€â”€ services/
â”‚   â””â”€â”€ ai_service.py           # âœ¨ å¢å¼ºAIæœåŠ¡
â”‚
â”œâ”€â”€ templates/pdf/
â”‚   â”œâ”€â”€ minimalist.html         # ç°æœ‰
â”‚   â””â”€â”€ minimalist_v2.html      # âœ¨ æ–°å¢å‚æ•°åŒ–ç‰ˆæœ¬
â”‚
â”œâ”€â”€ onepagers/
â”‚   â””â”€â”€ routes.py               # âœ¨ æ‰©å±•endpoints
â”‚
â””â”€â”€ scripts/
    â””â”€â”€ migrate_layout_params.py  # âœ¨ è¿ç§»è„šæœ¬
```

### AIæœåŠ¡æ¶æ„

#### æ–¹æ³•æ‰©å±•

```python
class AIService:

    # ç°æœ‰æ–¹æ³•ï¼ˆä¿ç•™ï¼‰
    async def refine_onepager(
        self,
        current_content: dict,
        user_feedback: str
    ) -> dict:
        """åªä¼˜åŒ–å†…å®¹"""
        pass

    # âœ¨ æ–°å¢æ–¹æ³•
    async def refine_onepager_with_design(
        self,
        current_content: dict,
        current_layout: dict,
        user_feedback: str,
        brand_kit: dict
    ) -> dict:
        """åŒæ—¶ä¼˜åŒ–å†…å®¹å’Œè®¾è®¡"""
        return {
            "content": {...},
            "layout_params": {...},
            "design_rationale": "..."
        }

    # âœ¨ æ–°å¢æ–¹æ³•
    async def suggest_layout(
        self,
        content: dict,
        current_layout: dict,
        brand_kit: dict
    ) -> dict:
        """ä»…è¿”å›å¸ƒå±€å»ºè®®ï¼ˆä¸æ”¹å†…å®¹ï¼‰"""
        return {
            "layout_params": {...},
            "rationale": "..."
        }
```

#### AI Promptç­–ç•¥

**System Promptå…³é”®å†…å®¹**ï¼š
- AIè§’è‰²å®šä½ï¼šä¸“ä¸šè®¾è®¡å¸ˆ + æ–‡æ¡ˆæ’°å†™è€…
- å“ç‰ŒæŒ‡å—çº¦æŸï¼ˆBrand Kitï¼‰
- è®¾è®¡åŸåˆ™ï¼ˆvisual hierarchyã€scanabilityç­‰ï¼‰
- å¸ƒå±€å‚æ•°çº¦æŸï¼ˆèŒƒå›´é™åˆ¶ï¼‰
- è¾“å‡ºJSONæ ¼å¼è¦æ±‚

**User Promptå…³é”®å†…å®¹**ï¼š
- å½“å‰å†…å®¹å’Œå¸ƒå±€
- å†…å®¹ç‰¹å¾åˆ†æï¼ˆfeatureæ•°é‡ç­‰ï¼‰
- ç”¨æˆ·åé¦ˆ
- è®¾è®¡æ„å›¾æ¨æ–­

**å“åº”æ ¼å¼**ï¼š
```json
{
  "content": {...},
  "layout_params": {...},
  "design_rationale": "è¯¦ç»†çš„è®¾è®¡å†³ç­–è¯´æ˜"
}
```

### PDFæ¨¡æ¿å‚æ•°åŒ–

#### CSSå˜é‡æ³¨å…¥

```html
<style>
:root {
  /* é¢œè‰² */
  --color-primary: {{ layout_params.color_scheme.primary }};

  /* å­—ä½“ç¼©æ”¾ */
  --scale-h1: {{ layout_params.typography.h1_scale }};

  /* é—´è· */
  {% if layout_params.spacing.section_gap == 'tight' %}
    --gap-section: 2rem;
  {% elif layout_params.spacing.section_gap == 'loose' %}
    --gap-section: 6rem;
  {% else %}
    --gap-section: 4rem;
  {% endif %}
}

h1 {
  font-size: calc(3.5rem * var(--scale-h1));
  color: var(--color-primary);
}

.section {
  margin-bottom: var(--gap-section);
}
</style>
```

#### åŠ¨æ€Gridå¸ƒå±€

```html
<div class="features-grid" style="
  grid-template-columns: repeat(
    {{ layout_params.section_layouts.features.columns }},
    1fr
  );
  text-align: {{ layout_params.section_layouts.features.alignment }};
">
  {% for feature in content.features %}
    <div class="feature-card">{{ feature }}</div>
  {% endfor %}
</div>
```

---

## å‰ç«¯æ¶æ„

### ç›®å½•ç»“æ„ï¼ˆæ–°å¢æ–‡ä»¶ï¼‰

```
frontend/src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ onepager.ts             # âœ¨ æ·»åŠ LayoutParamsæ¥å£
â”‚
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useOnePager.ts          # âœ¨ æ·»åŠ æ–°hooks
â”‚
â”œâ”€â”€ components/onepager/
â”‚   â”œâ”€â”€ WireframePreview.tsx    # âœ¨ æ–°å¢
â”‚   â”œâ”€â”€ DesignControlPanel.tsx  # âœ¨ æ–°å¢
â”‚   â””â”€â”€ OnePagerEditor.tsx      # ç°æœ‰ï¼ˆä¸å˜ï¼‰
â”‚
â”œâ”€â”€ pages/onepager/steps/
â”‚   â””â”€â”€ RefineStep.tsx          # âœ¨ æ‰©å±•
â”‚
â””â”€â”€ utils/
    â””â”€â”€ asciiGenerator.ts       # âœ¨ æ–°å¢
```

### ç»„ä»¶æ¶æ„

#### RefineStepç»„ä»¶å±‚æ¬¡

```
RefineStep
â”œâ”€â”€ ViewModeToggleï¼ˆWireframe â†” Previewï¼‰
â”œâ”€â”€ Left Panel (2/3å®½åº¦)
â”‚   â”œâ”€â”€ WireframePreviewï¼ˆWireframeæ¨¡å¼ï¼‰
â”‚   â”‚   â””â”€â”€ æ˜¾ç¤ºä½ä¿çœŸå¸ƒå±€é¢„è§ˆ
â”‚   â”œâ”€â”€ OnePagerEditorï¼ˆPreviewæ¨¡å¼ï¼‰
â”‚   â”‚   â””â”€â”€ æ˜¾ç¤ºé«˜ä¿çœŸé¢„è§ˆ
â”‚   â””â”€â”€ FeedbackPanel
â”‚       â””â”€â”€ ç”¨æˆ·åé¦ˆè¾“å…¥
â””â”€â”€ Right Panel (1/3å®½åº¦)
    â”œâ”€â”€ DesignControlPanel
    â”‚   â”œâ”€â”€ Spacing Tab
    â”‚   â”œâ”€â”€ Typography Tab
    â”‚   â””â”€â”€ Layout Tab
    â””â”€â”€ AI Design Rationale Display
```

#### WireframePreviewç»„ä»¶

**åŠŸèƒ½**ï¼š
- æ˜¾ç¤ºOnePagerçš„ä½ä¿çœŸç»“æ„é¢„è§ˆ
- ç”¨ç°è‰²æ–¹å—ä»£è¡¨æ–‡å­—å ä½
- ç”¨è™šçº¿è¾¹æ¡†æ ‡è®°section
- å®æ—¶å“åº”layout_paramså˜åŒ–

**è¾“å…¥**ï¼š
- onepager: OnePagerå¯¹è±¡
- layoutParams: LayoutParamså¯¹è±¡

**è¾“å‡º**ï¼š
- å¯è§†åŒ–çš„å¸ƒå±€ç»“æ„

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- ä½¿ç”¨React.memoé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
- ä½¿ç”¨useMemoç¼“å­˜è®¡ç®—

#### DesignControlPanelç»„ä»¶

**åŠŸèƒ½**ï¼š
- æä¾›UIæ§ä»¶è°ƒæ•´å¸ƒå±€å‚æ•°
- å®æ—¶é¢„è§ˆï¼ˆé€šè¿‡å›è°ƒé€šçŸ¥çˆ¶ç»„ä»¶ï¼‰
- è¯·æ±‚AIè®¾è®¡å»ºè®®
- åº”ç”¨/é‡ç½®æ›´æ”¹

**çŠ¶æ€ç®¡ç†**ï¼š
```typescript
const [localLayout, setLocalLayout] = useState<LayoutParams>(currentLayout);
const [hasChanges, setHasChanges] = useState(false);
```

**æ•°æ®æµ**ï¼š
```
ç”¨æˆ·æ‹–åŠ¨æ»‘å—
  â†’ setLocalLayout(æ–°å€¼)
  â†’ setHasChanges(true)
  â†’ onLayoutChange(æ–°å€¼)  // å›è°ƒé€šçŸ¥çˆ¶ç»„ä»¶
  â†’ çˆ¶ç»„ä»¶æ›´æ–°WireframePreview
```

**ç‚¹å‡»Apply**ï¼š
```
ç‚¹å‡»Apply
  â†’ updateMutation.mutate({onePagerId, layoutParams})
  â†’ APIè°ƒç”¨æˆåŠŸ
  â†’ React Queryè‡ªåŠ¨æ›´æ–°ç¼“å­˜
  â†’ ç»„ä»¶é‡æ–°æ¸²æŸ“
  â†’ setHasChanges(false)
```

### çŠ¶æ€ç®¡ç†ç­–ç•¥

#### React Queryç¼“å­˜ç­–ç•¥

```typescript
// OnePageræ•°æ®ç¼“å­˜
queryKey: ['onepager', onePagerId]
staleTime: 30000  // 30ç§’å†…ä¸é‡æ–°è¯·æ±‚
cacheTime: 300000 // 5åˆ†é’Ÿåæ¸…é™¤ç¼“å­˜

// æ›´æ–°ç­–ç•¥
onSuccess: () => {
  queryClient.invalidateQueries(['onepager', onePagerId]);
}
```

#### æœ¬åœ°çŠ¶æ€ç®¡ç†

- WireframePreviewï¼šæ— æœ¬åœ°çŠ¶æ€ï¼ˆå®Œå…¨å—æ§ç»„ä»¶ï¼‰
- DesignControlPanelï¼šæœ¬åœ°çŠ¶æ€å­˜ä¸´æ—¶ä¿®æ”¹ï¼ŒApplyæ—¶æäº¤

---

## æ•°æ®æµ

### å®Œæ•´è¿­ä»£æµç¨‹

```
1. ç”¨æˆ·è¿›å…¥RefineStep
   â†“
2. åŠ è½½OnePageræ•°æ®ï¼ˆåŒ…å«layout_paramsï¼‰
   â†“
3. é»˜è®¤æ˜¾ç¤ºWireframeæ¨¡å¼
   â†“
4. ç”¨æˆ·è°ƒæ•´è®¾è®¡å‚æ•°ï¼ˆæ‹–åŠ¨æ»‘å—ï¼‰
   â†“
5. WireframePreviewå®æ—¶æ›´æ–°ï¼ˆæœ¬åœ°é¢„è§ˆï¼‰
   â†“
6. ç”¨æˆ·ç‚¹å‡»"Apply Changes"
   â†“
7. è°ƒç”¨ PATCH /onepagers/{id}
   â†“
8. åç«¯æ›´æ–°æ•°æ®åº“
   â†“
9. React Queryæ›´æ–°ç¼“å­˜
   â†“
10. ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼ˆæ˜¾ç¤ºä¿å­˜åçš„çŠ¶æ€ï¼‰
```

### AIå»ºè®®æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»"Ask AI for Suggestion"
   â†“
2. è°ƒç”¨ POST /onepagers/{id}/suggest-layout
   â†“
3. åç«¯è°ƒç”¨AIæœåŠ¡
   â”œâ”€â”€ åˆ†æå½“å‰å†…å®¹
   â”œâ”€â”€ åˆ†æå½“å‰å¸ƒå±€
   â””â”€â”€ ç”Ÿæˆå»ºè®®
   â†“
4. AIè¿”å›{layout_params, rationale}
   â†“
5. å‰ç«¯æ˜¾ç¤ºè®¾è®¡ç†ç”±ï¼ˆToastï¼‰
   â†“
6. å‰ç«¯æ›´æ–°æœ¬åœ°layoutçŠ¶æ€
   â†“
7. WireframePreviewæ›´æ–°é¢„è§ˆ
   â†“
8. ç”¨æˆ·æ£€æŸ¥å¹¶å†³å®šæ˜¯å¦Apply
```

### AIè¿­ä»£æµç¨‹ï¼ˆç”¨æˆ·åé¦ˆï¼‰

```
1. ç”¨æˆ·åœ¨FeedbackPanelè¾“å…¥åé¦ˆï¼š"æ›´ç´§å‡‘ï¼Œfeatureç”¨2åˆ—"
   â†“
2. è°ƒç”¨ POST /onepagers/{id}/refine
   â†“
3. åç«¯è°ƒç”¨ refine_onepager_with_design()
   â”œâ”€â”€ AIåˆ†æåé¦ˆ
   â”œâ”€â”€ ä¼˜åŒ–å†…å®¹ï¼ˆheadlineç­‰ï¼‰
   â””â”€â”€ ä¼˜åŒ–å¸ƒå±€ï¼ˆspacingâ†’tight, features.columnsâ†’2ï¼‰
   â†“
4. AIè¿”å›{content, layout_params, design_rationale}
   â†“
5. åç«¯ä¿å­˜ç‰ˆæœ¬å¿«ç…§ï¼ˆåŒ…å«layout_paramsï¼‰
   â†“
6. åç«¯æ›´æ–°OnePageræ•°æ®
   â†“
7. å‰ç«¯æ¥æ”¶æ›´æ–°
   â”œâ”€â”€ æ˜¾ç¤ºæ–°å†…å®¹
   â”œâ”€â”€ æ˜¾ç¤ºæ–°å¸ƒå±€
   â””â”€â”€ æ˜¾ç¤ºè®¾è®¡ç†ç”±
   â†“
8. ç”¨æˆ·ç»§ç»­è¿­ä»£æˆ–è¿›å…¥Exportæ­¥éª¤
```

### PDFå¯¼å‡ºæµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»"Export PDF"
   â†“
2. è°ƒç”¨ POST /onepagers/{id}/export-pdf
   â†“
3. åç«¯è·å–OnePagerï¼ˆåŒ…å«layout_paramsï¼‰
   â†“
4. é€‰æ‹©æ¨¡æ¿ï¼ˆminimalist_v2.htmlï¼‰
   â†“
5. Jinja2æ¸²æŸ“æ¨¡æ¿
   â”œâ”€â”€ æ³¨å…¥content
   â””â”€â”€ æ³¨å…¥layout_paramsï¼ˆCSSå˜é‡ï¼‰
   â†“
6. Playwrightç”ŸæˆPDF
   â†“
7. è¿”å›PDFæ–‡ä»¶ç»™ç”¨æˆ·
```

---

## å…³é”®æŠ€æœ¯å†³ç­–

### å†³ç­–1ï¼šå‚æ•°åŒ–æ¨¡æ¿ vs åŠ¨æ€å¸ƒå±€å¼•æ“

**é€‰æ‹©**ï¼šå‚æ•°åŒ–æ¨¡æ¿ï¼ˆæ–¹æ¡ˆBï¼‰
**ç†ç”±**ï¼š
- å¼€å‘æ—¶é—´å¯æ§ï¼ˆ7å¤©ï¼‰
- è´¨é‡æœ‰ä¿éšœï¼ˆä¿ç•™ä¸“ä¸šè®¾è®¡ï¼‰
- å¯æ‰©å±•æ€§è¶³å¤Ÿ

**æ›¿ä»£æ–¹æ¡ˆ**ï¼š
- åŠ¨æ€å¸ƒå±€å¼•æ“ï¼ˆæ–¹æ¡ˆCï¼‰ï¼šå·¥ç¨‹é‡å¤ªå¤§ï¼ˆ80-100hï¼‰

---

### å†³ç­–2ï¼šWireframeé¢„è§ˆå®ç°æ–¹å¼

**é€‰æ‹©**ï¼šReactç»„ä»¶æ¸²æŸ“ï¼ˆæ–¹æ¡ˆ3ï¼šFigma-styleï¼‰
**ç†ç”±**ï¼š
- è§†è§‰æ•ˆæœæœ€å¥½
- ç”¨æˆ·ä½“éªŒä¸“ä¸š
- å®æ—¶æ›´æ–°æµç•…

**æ›¿ä»£æ–¹æ¡ˆ**ï¼š
- çº¯ASCIIï¼ˆæ–¹æ¡ˆ2ï¼‰ï¼šè§†è§‰æ•ˆæœå·®ï¼Œä½†ä½œä¸ºå¯¼å‡ºåŠŸèƒ½ä¿ç•™
- CSS Wireframeï¼ˆæ–¹æ¡ˆ1ï¼‰ï¼šæŠ˜ä¸­æ–¹æ¡ˆï¼Œæš‚ä¸å®æ–½

---

### å†³ç­–3ï¼šçŠ¶æ€ç®¡ç†ç­–ç•¥

**é€‰æ‹©**ï¼šReact Query + æœ¬åœ°useState
**ç†ç”±**ï¼š
- React Queryå¤„ç†æœåŠ¡å™¨çŠ¶æ€ï¼ˆOnePageræ•°æ®ï¼‰
- useStateå¤„ç†UIçŠ¶æ€ï¼ˆä¸´æ—¶ä¿®æ”¹ï¼‰
- æ¸…æ™°çš„çŠ¶æ€è¾¹ç•Œ

**æ›¿ä»£æ–¹æ¡ˆ**ï¼š
- Reduxï¼šè¿‡äºå¤æ‚ï¼Œä¸éœ€è¦å…¨å±€çŠ¶æ€
- Zustandï¼šä¸éœ€è¦è·¨ç»„ä»¶å…±äº«çŠ¶æ€

---

### å†³ç­–4ï¼šå‘åå…¼å®¹ç­–ç•¥

**é€‰æ‹©**ï¼šå¯é€‰å­—æ®µ + é»˜è®¤å€¼
**ç†ç”±**ï¼š
- ä¸ç ´åç°æœ‰æ•°æ®
- è¿ç§»å®‰å…¨
- å¯éšæ—¶å›æ»š

**å®æ–½**ï¼š
- layout_paramså­—æ®µOptional
- è¯»å–æ—¶å¦‚æœä¸ºNoneï¼Œä½¿ç”¨é»˜è®¤å€¼
- ç‰ˆæœ¬å†å²ä¹Ÿè®°å½•layout_params

---

### å†³ç­–5ï¼šAI Promptç­–ç•¥

**é€‰æ‹©**ï¼šç»“æ„åŒ–Prompt + JSONè¾“å‡º
**ç†ç”±**ï¼š
- æ˜ç¡®çš„è¾“å‡ºæ ¼å¼
- æ˜“äºéªŒè¯å’Œè§£æ
- è®¾è®¡çº¦æŸæ¸…æ™°

**é£é™©ç¼“è§£**ï¼š
- SchemaéªŒè¯ï¼šPydanticéªŒè¯è¾“å‡º
- Fallbackæœºåˆ¶ï¼šå¦‚æœæ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼
- æ—¥å¿—è®°å½•ï¼šè®°å½•AIåŸå§‹å“åº”

---

## éåŠŸèƒ½æ€§éœ€æ±‚

### æ€§èƒ½è¦æ±‚

| æŒ‡æ ‡ | è¦æ±‚ | å®ç°æ–¹å¼ |
|------|------|---------|
| APIå“åº”æ—¶é—´ | <2s (p95) | AIè°ƒç”¨timeout 10s |
| Wireframeæ›´æ–° | 60fps | React.memo + useMemo |
| PDFç”Ÿæˆæ—¶é—´ | <5s | ä¼˜åŒ–æ¨¡æ¿å¤§å° |
| é¦–å±åŠ è½½ | <1s | ä»£ç åˆ†å‰² |

### å¯é æ€§è¦æ±‚

| åœºæ™¯ | è¦æ±‚ | å®ç°æ–¹å¼ |
|------|------|---------|
| AIæœåŠ¡å¤±è´¥ | ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ | ä½¿ç”¨é»˜è®¤å€¼ + æç¤ºç”¨æˆ· |
| æ•°æ®åº“è¿ç§»å¤±è´¥ | å¯å›æ»š | å®Œæ•´å¤‡ä»½ + å›æ»šè„šæœ¬ |
| PDFç”Ÿæˆå¤±è´¥ | å‹å¥½é”™è¯¯æç¤º | try-catch + ç”¨æˆ·æç¤º |

### å¯ç»´æŠ¤æ€§è¦æ±‚

- **ä»£ç æ³¨é‡Š**ï¼šæ‰€æœ‰æ–°ä»£ç æœ‰docstring
- **æ–‡æ¡£å®Œæ•´**ï¼šAPIæ–‡æ¡£ã€æ¶æ„æ–‡æ¡£ã€ä½¿ç”¨æ–‡æ¡£
- **æµ‹è¯•è¦†ç›–**ï¼šå•å…ƒæµ‹è¯•>90%ï¼ŒE2Eæµ‹è¯•è¦†ç›–ä¸»æµç¨‹

---

## å®‰å…¨æ€§è€ƒè™‘

### è¾“å…¥éªŒè¯
- å‰ç«¯ï¼šTypeScriptç±»å‹æ£€æŸ¥
- åç«¯ï¼šPydantic schemaéªŒè¯
- èŒƒå›´æ£€æŸ¥ï¼šh1_scaleé™åˆ¶åœ¨0.8-1.5

### æƒé™æ§åˆ¶
- ç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„OnePager
- API endpointä½¿ç”¨get_current_userä¾èµ–

### æ•°æ®å¤‡ä»½
- è¿ç§»å‰å®Œæ•´å¤‡ä»½
- ç‰ˆæœ¬å†å²æœºåˆ¶ï¼ˆå¯å›æ»šåˆ°ä»»æ„ç‰ˆæœ¬ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2025-01-18
**ç»´æŠ¤è€…**ï¼šClaude AI + Anthony
